# Deploy Product Service Infrastructure
# Creates: MongoDB database in Cosmos DB + Key Vault secrets
# Triggers: Manual dispatch or changes to .azure/infrastructure/**

name: Deploy Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod

  push:
    branches:
      - main
    paths:
      - '.azure/infrastructure/**'

permissions:
  id-token: write
  contents: read

env:
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}

jobs:
  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}

      - name: Set environment variables
        id: env
        run: |
          ENV="${{ github.event.inputs.environment || 'dev' }}"
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "resource_group=rg-xshopai-$ENV" >> $GITHUB_OUTPUT

      - name: Deploy Infrastructure
        uses: azure/arm-deploy@v2
        with:
          subscriptionId: ${{ env.AZURE_SUBSCRIPTION_ID }}
          resourceGroupName: ${{ steps.env.outputs.resource_group }}
          template: .azure/infrastructure/main.bicep
          parameters: >
            environment=${{ steps.env.outputs.environment }}
          failOnStdErr: false
          deploymentName: product-service-infra-${{ github.run_number }}

      - name: Create Role Assignments (Idempotent)
        run: |
          ENV="${{ steps.env.outputs.environment }}"
          
          # Get resource IDs
          MANAGED_IDENTITY_NAME="id-xshopai-$ENV"
          ACR_NAME="${{ steps.env.outputs.environment == 'prod' && 'xshopaimodulesprod' || 'xshopaimodulesdev' }}"
          KEY_VAULT_NAME="kv-xshopai-${ENV}2"
          RG="rg-xshopai-$ENV"
          
          echo "Fetching managed identity principal ID..."
          PRINCIPAL_ID=$(az identity show --name $MANAGED_IDENTITY_NAME --resource-group $RG --query principalId -o tsv)
          echo "Principal ID: $PRINCIPAL_ID"
          
          # Role definition IDs
          ACR_PULL_ROLE="7f951dda-4ed3-4680-a7ca-43fe172d538d"
          KEY_VAULT_SECRETS_USER_ROLE="4633458b-17de-408a-b874-0445c86b69e6"
          
          # Get resource IDs
          ACR_ID=$(az acr show --name $ACR_NAME --query id -o tsv)
          KV_ID=$(az keyvault show --name $KEY_VAULT_NAME --query id -o tsv)
          
          echo "ACR ID: $ACR_ID"
          echo "Key Vault ID: $KV_ID"
          
          # Function to assign role idempotently
          assign_role() {
            local SCOPE=$1
            local ROLE=$2
            local NAME=$3
            
            echo "Assigning $NAME role..."
            OUTPUT=$(az role assignment create \
              --assignee-object-id "$PRINCIPAL_ID" \
              --assignee-principal-type ServicePrincipal \
              --scope "$SCOPE" \
              --role "$ROLE" 2>&1) || true
            
            if echo "$OUTPUT" | grep -qi "already exists\|RoleAssignmentExists"; then
              echo "✓ $NAME role assignment already exists"
            elif echo "$OUTPUT" | grep -q "roleDefinitionId"; then
              echo "✓ $NAME role assignment created"
            else
              echo "Result: $OUTPUT"
            fi
          }
          
          # Assign roles
          assign_role "$ACR_ID" "$ACR_PULL_ROLE" "AcrPull"
          assign_role "$KV_ID" "$KEY_VAULT_SECRETS_USER_ROLE" "Key Vault Secrets User"
          
          echo "Role assignments complete!"

      - name: Deployment Summary
        run: |
          echo "## Infrastructure Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| MongoDB Database (productdb) | ✅ Deployed |" >> $GITHUB_STEP_SUMMARY
          echo "| Products Collection | ✅ Created |" >> $GITHUB_STEP_SUMMARY
          echo "| Key Vault Secrets (mongodb-uri, mongodb-database) | ✅ Configured |" >> $GITHUB_STEP_SUMMARY
          echo "| Role Assignments (AcrPull, Key Vault Secrets User) | ✅ Created (idempotent) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> **Note:** Role assignments use Azure CLI for idempotency - safe to re-run" >> $GITHUB_STEP_SUMMARY
