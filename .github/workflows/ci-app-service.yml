# ==============================================================================
# Product Service — CI + Deploy to Azure App Service
# ==============================================================================
# On push/PR: build & test only.
# On workflow_dispatch or push-to-main: build, test, then deploy.
#
# Prerequisites: Infra workflow must have created the App Service shell with
# all settings pre-configured. This workflow only deploys code.
# ==============================================================================

name: CI App Service

on:
  push:
    branches: [main, develop]
    paths:
      - "app/**"
      - "requirements*.txt"
      - "main.py"
      - "Dockerfile"
      - ".github/workflows/ci-app-service.yml"

  pull_request:
    branches: [main]
    paths:
      - "app/**"
      - "requirements*.txt"
      - "main.py"
      - "Dockerfile"

  workflow_dispatch:
    inputs:
      environment:
        description: "Environment"
        required: true
        type: choice
        options: [dev, prod]
        default: dev
      suffix:
        description: "Resource suffix (e.g. as01) — leave blank to use org default"
        required: false
        default: ""

env:
  PYTHON_VERSION: "3.12" # Must match infrastructure runtime (PYTHON:3.12)
  SERVICE_NAME: product-service
  PROJECT_NAME: xshopai

# ==============================================================================
# Job 1 — Build & Test (runs on every trigger)
# ==============================================================================
jobs:
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install dev dependencies
        run: pip install -r requirements-dev.txt || true

      - name: Run linting
        run: |
          pip install flake8 black isort
          flake8 app/ --count --select=E9,F63,F7,F82 --show-source --statistics || true
          black --check app/ || true
        continue-on-error: true

      - name: Run unit tests
        run: |
          pip install pytest pytest-cov pytest-asyncio
          python -m pytest tests/unit -v --tb=short || true
        continue-on-error: true

      # Upload source for deployment (only when deploying)
      - name: Upload build artifacts
        if: >
          (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
          github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v6
        with:
          name: build-artifacts
          path: |
            **/*
            !.git/**
            !.github/**
            !tests/**
            !*.log
            !.env*
            !.dapr/**
            !docker-compose*
            !.vscode/**
            !docs/**
            !scripts/**
            !__pycache__/**
            !*.pyc
            !.pytest_cache/**
          retention-days: 1

  # ============================================================================
  # Job 2 — Deploy to Azure App Service
  # Runs only on: push to main  OR  manual workflow_dispatch
  # Assumes: App Service shell already exists with settings pre-configured by
  # the infrastructure workflow. This job only deploys code.
  # ============================================================================
  deploy:
    name: Deploy (${{ inputs.environment || 'dev' }})
    runs-on: ubuntu-latest
    needs: build-and-test
    if: >-
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      github.event_name == 'workflow_dispatch'

    environment:
      name: ${{ inputs.environment || 'dev' }}

    permissions:
      id-token: write
      contents: read

    steps:
      # Download pre-built artifacts from build-and-test job
      - name: Download build artifacts
        uses: actions/download-artifact@v7
        with:
          name: build-artifacts
          path: .

      - name: Azure login (OIDC)
        uses: azure/login@v2.3.0
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # -------------------------------------------------------------------
      # Resolve App Service name (must match infra naming convention)
      # -------------------------------------------------------------------
      - name: Resolve configuration
        run: |
          ENV="${{ inputs.environment || 'dev' }}"
          INPUT_SUFFIX="${{ inputs.suffix }}"

          if [ -n "$INPUT_SUFFIX" ]; then
            SUFFIX="$INPUT_SUFFIX"
          elif [ "$ENV" = "prod" ]; then
            SUFFIX="${{ vars.DEPLOY_SUFFIX_PROD }}"
          else
            SUFFIX="${{ vars.DEPLOY_SUFFIX_DEV }}"
          fi

          if [ -z "$SUFFIX" ]; then
            echo "::error::No suffix resolved — set DEPLOY_SUFFIX_DEV / DEPLOY_SUFFIX_PROD org variables or pass the suffix input"
            exit 1
          fi

          # Infrastructure naming: app-{service}-{project}-{suffix}
          # Note: suffix already includes environment context (e.g., "development" for dev)
          APP_NAME="app-${{ env.SERVICE_NAME }}-${{ env.PROJECT_NAME }}-${SUFFIX}"
          RESOURCE_GROUP="rg-${{ env.PROJECT_NAME }}-${SUFFIX}"

          {
            echo "ENV=$ENV"
            echo "SUFFIX=$SUFFIX"
            echo "APP_NAME=$APP_NAME"
            echo "RESOURCE_GROUP=$RESOURCE_GROUP"
          } >> "$GITHUB_ENV"

          echo "Deploying **${{ env.SERVICE_NAME }}** → \`${APP_NAME}\`"

          # Verify App Service exists (created by infra workflow)
          if ! az webapp show --name "$APP_NAME" --resource-group "$RESOURCE_GROUP" &>/dev/null; then
            echo "::error::App Service '$APP_NAME' not found. Run the infrastructure workflow first."
            exit 1
          fi

      # -------------------------------------------------------------------
      # Create deployment package (App Service Oryx will handle pip install)
      # -------------------------------------------------------------------
      - name: Create deployment package
        run: |
          echo "Creating deployment package..."
          zip -r ${{ github.workspace }}/deploy.zip . -x "*.git*" -x "tests/*" -x ".github/*" -x "*.log" -x ".env*" -x "__pycache__/*" -x "*.pyc" -q
          echo "✓ Package created: $(du -h deploy.zip | cut -f1)"

      # -------------------------------------------------------------------
      # Deploy to App Service (Oryx handles Python build automatically)
      # -------------------------------------------------------------------
      - name: Deploy to App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.APP_NAME }}
          resource-group-name: ${{ env.RESOURCE_GROUP }}
          package: ${{ github.workspace }}/deploy.zip

      # -------------------------------------------------------------------
      # Health check
      # -------------------------------------------------------------------
      - name: Verify deployment
        run: |
          URL="https://${APP_NAME}.azurewebsites.net/health/live"
          echo "Deployment complete. Performing basic health check..."
          echo "App Service URL: $URL"

          # Brief check - App Service health monitoring will catch issues
          for i in {1..5}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$URL" 2>/dev/null || echo "000")
            if [[ "$HTTP_CODE" =~ ^(200|204)$ ]]; then
              echo "✓ Service is responding (HTTP $HTTP_CODE)"
              echo "Note: App Service continues monitoring at ${URL}"
              exit 0
            fi
            echo "  Attempt $i/5 — HTTP $HTTP_CODE — waiting 15s..."
            sleep 15
          done

          echo "::warning::Initial health check timed out. Check App Service logs and health monitoring."

      # -------------------------------------------------------------------
      # Summary
      # -------------------------------------------------------------------
      - name: Deployment summary
        if: always()
        run: |
          {
            echo "## ${{ env.SERVICE_NAME }} Deployment"
            echo ""
            echo "| | |"
            echo "|---|---|"
            echo "| Environment | \`${ENV}\` |"
            echo "| Suffix | \`${SUFFIX}\` |"
            echo "| App Service | \`${APP_NAME}\` |"
            echo "| URL | https://${APP_NAME}.azurewebsites.net |"
            echo "| Runtime | Python ${{ env.PYTHON_VERSION }} |"
            echo "| Commit | \`${{ github.sha }}\` |"
          } >> "$GITHUB_STEP_SUMMARY"
